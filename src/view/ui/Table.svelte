<script lang="ts">
    import type { Monster } from "index";
    import type { LayoutSettings, TableItem } from "types/layout";
    import { stringify } from "src/util/util";
    import TextContentHolder from "./TextContentHolder.svelte";
  import { getContext } from "svelte";

    export let monster: Monster;
    export let item: TableItem;

    const settings = getContext<LayoutSettings>('layoutSettings')

    function getMod(value: string | number) {
        let mod;

        let func;
        let modifier;
        if (
            item.modifier == null ||
            !item.modifier.length ||
            item.modifier == ""
        ) {
            modifier = settings.defaultTableModifier
        } else {
            modifier = item.modifier
        }

        func = modifier.contains("return")
            ? modifier
            : `return ${modifier}`;

        // Allow both "value" and "stat" syntax while transitioning
        const customMod = new Function("value", "stat", func);
        const argument = isNaN(Number(value)) ? value : Number(value);
        mod = customMod(argument, argument);

        if(typeof mod == "number"){
            return `(${mod >= 0 ? "+" : "-"}${Math.abs(mod)})`;
        }else {
            return `${mod}`;
        }
    }

    let values: any[] = monster[item.properties[0]] as any[];
    if (!Array.isArray(values)) {
        values = [];
    }

    const valueMap: Map<number, number[]> = new Map();
    for (let index = 0; index < values.length; index++) {
        const value = values[index];
        if (Array.isArray(value)) {
            for (let vIndex = 0; vIndex < value.length; vIndex++) {
                const existing = valueMap.get(vIndex) ?? [];
                existing.push(value[vIndex]);
                valueMap.set(vIndex, existing);
            }
        } else {
            valueMap.set(index, [value]);
        }
    }

    const headers = item.headers ?? [
        ...Array(values.length > 0 ? values.length : 1).keys()
    ];
</script>

<div class="statblock-table">
    {#each [...valueMap.entries()].slice(0, headers.length) as [index, values]}
        <div class="table-item">
            <span class="statblock-table-header">{headers[index]}</span>
            {#each values as value}
                <span>
                    <TextContentHolder property={stringify(value)} />
                    {#if !(item.calculate === false)}
                        <span>
                            {getMod(value)}
                        </span>
                    {/if}
                </span>
            {/each}
        </div>
    {/each}
</div>

<style>
    .statblock-table-header {
        font-weight: var(--statblock-table-header-font-weight);
    }
    .statblock-table {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        flex-wrap: wrap;
    }
    .table-item {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-flow: column nowrap;
    }
</style>
